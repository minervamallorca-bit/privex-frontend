import React, { useState, useEffect, useRef } from 'react';
import { useChat } from '../hooks/useChat';
import { decryptMessage } from '../services/encryption';
import logo from '../logo.png';
import chatBg from '../chat-bg.jpg'; // IMPORT THE WALLPAPER

export default function ChatRoom({ user, logout }) {
  const { messages, sendMessage } = useChat();
  const [text, setText] = useState('');
  const [isDecrypted, setIsDecrypted] = useState(false);

  // UI States
  const [windowWidth, setWindowWidth] = useState(window.innerWidth);
  const [showChatOnMobile, setShowChatOnMobile] = useState(false);
  
  // PROFILE STATES
  const [showProfile, setShowProfile] = useState(false);
  const [myProfile, setMyProfile] = useState({ name: 'Privex User', status: 'Available', avatar: logo });

  // MOCK DATA
  const [chats, setChats] = useState([
    { id: 1, name: 'Privex Bot', lastMsg: 'Welcome to PrivexApp', time: 'Now', unread: 0, avatar: 'ü§ñ' },
    { id: 2, name: 'Team Alpha', lastMsg: 'Meeting at 3 PM', time: '10:30', unread: 2, avatar: 'üë•' },
    { id: 3, name: 'Alice Smith', lastMsg: 'See you tomorrow!', time: 'Yest', unread: 0, avatar: 'üë§' },
    { id: 4, name: 'Marketing', lastMsg: 'New logo approved', time: 'Mon', unread: 1, avatar: 'üì¢' },
    { id: 5, name: 'John Doe', lastMsg: 'Sent a file', time: 'Sun', unread: 0, avatar: 'üë§' },
  ]);
  const [activeChatId, setActiveChatId] = useState(1);

  // Safe check for current active chat
  const activeChat = chats.find(c => c.id === activeChatId) || chats[0];

  // Auto-scroll
  const messagesEndRef = useRef(null);
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };
  useEffect(scrollToBottom, [messages, showChatOnMobile]);

  useEffect(() => {
    const handleResize = () => setWindowWidth(window.innerWidth);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  const isMobile = windowWidth < 768;

  // --- ACTIONS ---

  const handleSend = () => {
    if (!text.trim()) return;
    sendMessage(text);
    setText('');
  };

  const handleVoiceMessage = () => sendMessage("üé§ Voice Message (0:15)");

  const handleAttachment = (type) => {
    sendMessage(type === 'photo' ? "üì∑ IMG_2024.jpg" : "üìÑ Project_Brief.pdf");
  };

  const handleCall = (type) => {
    alert(`Starting ${type} call with ${activeChat?.name}... \n(Simulation)`);
  };

  const handleChatClick = (id) => {
    setActiveChatId(id);
    if (isMobile) setShowChatOnMobile(true);
  };

  const handleCreateGroup = () => {
    const group = prompt("Enter Group Name:");
    if (group) setChats([{ id: Date.now(), name: group, lastMsg: 'Group created', time: 'Now', unread: 0, avatar: 'üì¢' }, ...chats]);
  };

  const handleDeleteFriend = () => {
    if (!activeChat) return;
    const confirmDelete = window.confirm(`Are you sure you want to remove ${activeChat.name} from your friends?`);
    if (confirmDelete) {
      const updatedChats = chats.filter(c => c.id !== activeChatId);
      setChats(updatedChats);
      if (updatedChats.length > 0) setActiveChatId(updatedChats[0].id);
      if (isMobile) setShowChatOnMobile(false);
    }
  };

  // --- PROFILE LOGIC ---
  const handleSaveProfile = (e) => {
    e.preventDefault();
    const newName = e.target.name.value;
    const newStatus = e.target.status.value;
    setMyProfile({ ...myProfile, name: newName, status: newStatus });
    setShowProfile(false);
    alert("Profile Updated Successfully! ‚úÖ");
  };

  return (
    <div style={styles.appContainer}>

      {/* ================= PROFILE MODAL ================= */}
      {showProfile && (
        <div style={styles.modalOverlay}>
          <div style={styles.modalContent}>
            <h2 style={{color:'#0066cc', marginBottom:'20px'}}>Edit Profile</h2>
            
            <div style={{display:'flex', justifyContent:'center', marginBottom:'20px'}}>
              <img src={myProfile.avatar} alt="Avatar" style={{width:'80px', height:'80px', borderRadius:'50%', border:'3px solid #ffff00'}} />
            </div>

            <form onSubmit={handleSaveProfile} style={{display:'flex', flexDirection:'column', gap:'15px'}}>
              <div>
                <label style={styles.label}>Display Name</label>
                <input name="name" defaultValue={myProfile.name} style={styles.modalInput} />
              </div>
              <div>
                <label style={styles.label}>Status</label>
                <input name="status" defaultValue={myProfile.status} style={styles.modalInput} />
              </div>
              
              <div style={{display:'flex', justifyContent:'space-between', marginTop:'10px'}}>
                <button type="button" onClick={() => setShowProfile(false)} style={{...styles.yellowButtonStyle, background:'#ccc', border:'2px solid #bbb', color:'#333'}}>Cancel</button>
                <button type="submit" style={styles.yellowButtonStyle}>Save Profile</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* ================= SIDEBAR ================= */}
      <div style={{
        ...styles.sidebar,
        display: (isMobile && showChatOnMobile) ? 'none' : 'flex',
        width: isMobile ? '100%' : '260px'
      }}>

        {/* Header */}
        <div style={styles.sidebarHeader}>
          <img 
            src={myProfile.avatar} 
            alt="Logo" 
            onClick={() => setShowProfile(true)}
            title="Edit My Profile"
            style={{...styles.userAvatar, cursor:'pointer', border:'2px solid #e6c200'}} 
          />
          
          <div style={styles.sidebarActions}>
            <button onClick={() => setShowProfile(true)} title="My Profile" style={styles.yellowButtonStyle}>üë§</button>
            <button onClick={handleCreateGroup} title="New Group" style={styles.yellowButtonStyle}>üë•</button>
            <button onClick={() => alert("Add Friend")} title="Add Friend" style={styles.yellowButtonStyle}>‚ûï</button>
            <button onClick={logout} title="Logout" style={styles.yellowButtonStyle}>üö™</button>
          </div>
        </div>

        {/* Search */}
        <div style={styles.searchContainer}>
          <input placeholder="Search..." style={styles.searchInput} />
        </div>

        {/* List */}
        <div style={styles.chatList}>
          {chats.map(chat => (
            <div
              key={chat.id}
              onClick={() => handleChatClick(chat.id)}
              style={{
                ...styles.chatItem,
                backgroundColor: activeChatId === chat.id && !isMobile ? '#f0f2f5' : 'white'
              }}
            >
              <div style={styles.chatAvatar}>{chat.avatar}</div>
              <div style={styles.chatInfo}>
                <div style={styles.chatRowTop}>
                  <span style={styles.chatName}>{chat.name}</span>
                  <span style={styles.chatTime}>{chat.time}</span>
                </div>
                <div style={styles.chatRowBottom}>
                  <span style={styles.chatMsg}>{chat.lastMsg}</span>
                  {chat.unread > 0 && <span style={styles.unreadBadge}>{chat.unread}</span>}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* ================= MAIN CHAT ================= */}
      <div style={{
        ...styles.mainChat,
        display: (isMobile && !showChatOnMobile) ? 'none' : 'flex',
        flex: 1
      }}>

        {/* HEADER BAR */}
        <div style={styles.chatHeader}>
          <div style={styles.headerLeft}>
            {isMobile && (
              <button onClick={() => setShowChatOnMobile(false)} style={styles.backBtn}>‚¨Ö</button>
            )}
            <div style={styles.currentAvatar}>
              {activeChat?.avatar || '‚ùì'}
            </div>
            <div style={styles.headerInfo}>
              <div style={styles.headerName}>
                {activeChat?.name || 'Select a Chat'}
              </div>
              <div style={styles.headerStatus}>online</div>
            </div>
          </div>

          <div style={styles.headerRight}>
            <button onClick={() => handleCall('Audio')} style={styles.yellowButtonStyle} title="Voice Call">üìû</button>
            <button onClick={() => handleCall('Video')} style={styles.yellowButtonStyle} title="Video Call">üìπ</button>
            <div style={styles.divider}></div>
            <button onClick={() => handleAttachment('photo')} style={styles.yellowButtonStyle} title="Send Photo">üì∑</button>
            <button onClick={() => handleAttachment('doc')} style={styles.yellowButtonStyle} title="Send Document">üìÑ</button>
            <div style={styles.divider}></div>
            <button onClick={handleDeleteFriend} style={{...styles.yellowButtonStyle, color: 'red'}} title="Unfollow / Delete">üóëÔ∏è</button>
            <div style={styles.divider}></div>
            <div
              onClick={() => setIsDecrypted(!isDecrypted)}
              style={{...styles.yellowButtonStyle, opacity: isDecrypted ? 1 : 0.7, display: 'flex', alignItems: 'center', justifyContent: 'center'}}
              title={isDecrypted ? "Secure" : "Encrypted"}
            >
              {isDecrypted ? 'üîì' : 'üîí'}
            </div>
          </div>
        </div>

        {/* Messages - NOW WITH BACKGROUND WALLPAPER */}
        <div style={styles.messagesArea}>
          {messages.map((m, i) => {
            const isMe = m.senderEmail === 'Me';
            const displayText = isDecrypted ? decryptMessage(m.content) : m.content;
            const isMedia = displayText.startsWith('üì∑') || displayText.startsWith('üìÑ') || displayText.startsWith('üé§');

            return (
              <div key={i} style={{ ...styles.msgRow, justifyContent: isMe ? 'flex-end' : 'flex-start' }}>
                <div style={{
                  ...styles.bubble,
                  backgroundColor: isMe ? (isMedia ? '#dcf8c6' : '#e1f5fe') : '#ffffff',
                  borderRadius: isMe ? '10px 0 10px 10px' : '0 10px 10px 10px',
                }}>
                  {!isMe && <div style={styles.senderLabel}>{myProfile.name}</div>}
                  <div style={{
                    color: isMedia ? '#555' : '#303030',
                    fontSize: '14.2px',
                    fontFamily: isDecrypted ? 'Helvetica, Arial' : '"Courier New", monospace',
                    wordBreak: 'break-word'
                  }}>
                    {displayText}
                  </div>
                  <div style={styles.timestamp}>
                    {new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                  </div>
                </div>
              </div>
            );
          })}
          <div ref={messagesEndRef} />
        </div>

        {/* Input Bar */}
        <div style={styles.inputBar}>
          <div style={styles.inputContainer}>
            <input
              style={styles.inputField}
              value={text}
              onChange={e => setText(e.target.value)}
              placeholder={isDecrypted ? "Type..." : "Type (Encrypted)..."}
              onKeyPress={e => e.key === 'Enter' ? handleSend() : null}
            />
          </div>
          {text.length > 0 ? (
            <button onClick={handleSend} style={{...styles.yellowButtonStyle, padding: '6px 15px'}}>‚û§</button>
          ) : (
            <button onClick={handleVoiceMessage} style={{...styles.yellowButtonStyle, padding: '6px 15px'}}>üé§</button>
          )}
        </div>
      </div>
    </div>
  );
}

// === STYLES ===
const styles = {
  appContainer: { display: 'flex', height: '100vh', width: '100vw', overflow: 'hidden', fontFamily: 'Segoe UI, Helvetica, Arial, sans-serif' },

  // GLOSSY YELLOW BUTTONS
  yellowButtonStyle: {
    background: 'linear-gradient(to bottom, #ffff00 5%, #ffdd00 100%)',
    backgroundColor: '#ffff00',
    borderRadius: '20px',
    border: '2px solid #e6c200',
    display: 'inline-block',
    cursor: 'pointer',
    color: '#ffffff',
    fontFamily: 'Arial',
    fontSize: '16px',
    fontWeight: 'bold',
    padding: '6px 12px',
    textDecoration: 'none',
    textShadow: '0px 1px 0px #998200',
    boxShadow: 'inset 0 1px 0 0 #fff6af, 0 2px 5px rgba(0,0,0,0.2)',
    transition: 'all 0.3s ease',
    outline: 'none',
    margin: '0 2px'
  },

  // MODAL STYLES
  modalOverlay: {
    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
    backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 1000,
    display: 'flex', alignItems: 'center', justifyContent: 'center'
  },
  modalContent: {
    backgroundColor: 'white', padding: '25px', borderRadius: '15px', width: '300px',
    boxShadow: '0 5px 15px rgba(0,0,0,0.3)', textAlign: 'center'
  },
  label: { display: 'block', textAlign: 'left', fontWeight: 'bold', marginBottom: '5px', fontSize:'13px', color:'#555' },
  modalInput: { width: '100%', padding: '8px', borderRadius: '5px', border: '1px solid #ddd', fontSize:'14px' },

  // SIDEBAR
  sidebar: { borderRight: '1px solid #ddd', flexDirection: 'column', backgroundColor: '#ffffff', transition: '0.3s' },
  sidebarHeader: { height: '60px', backgroundColor: '#f0f2f5', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 10px', borderBottom: '1px solid #ddd' },
  userAvatar: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'contain', backgroundColor: 'white', padding: '2px' },
  sidebarActions: { display: 'flex', gap: '5px', alignItems: 'center' },

  searchContainer: { padding: '8px', borderBottom: '1px solid #f0f2f5' },
  searchInput: { width: '100%', padding: '6px 10px', borderRadius: '5px', border: '1px solid #eee', backgroundColor: '#f0f2f5', outline: 'none', fontSize: '13px' },

  chatList: { flex: 1, overflowY: 'auto' },
  chatItem: { display: 'flex', alignItems: 'center', padding: '8px 10px', cursor: 'pointer', borderBottom: '1px solid #f7f7f7' },
  chatAvatar: { width: '35px', height: '35px', borderRadius: '50%', backgroundColor: '#eee', display:'flex', alignItems:'center', justifyContent:'center', fontSize: '18px', marginRight: '10px', flexShrink: 0 },
  chatInfo: { flex: 1, minWidth: 0 },
  chatRowTop: { display: 'flex', justifyContent: 'space-between', marginBottom: '2px' },
  chatName: { fontWeight: '600', fontSize: '14px', color: '#111b21' },
  chatTime: { fontSize: '11px', color: '#667781' },
  chatRowBottom: { display: 'flex', justifyContent: 'space-between' },
  chatMsg: { fontSize: '12px', color: '#667781', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', maxWidth: '100%' },
  unreadBadge: { backgroundColor: '#25d366', color: 'white', fontSize: '10px', padding: '2px 5px', borderRadius: '10px', fontWeight: 'bold' },

  // MAIN CHAT
  mainChat: { flexDirection: 'column', position: 'relative' },
  chatHeader: { height: '60px', backgroundColor: '#0066cc', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 15px', color: 'white' },
  headerLeft: { display: 'flex', alignItems: 'center', gap: '10px' },
  headerRight: { display: 'flex', alignItems: 'center', gap: '5px' },
  divider: { width: '1px', height: '24px', background: 'rgba(255,255,255,0.3)', margin: '0 4px' },
  backBtn: { background: 'none', border: 'none', color: 'white', fontSize: '20px', cursor: 'pointer', paddingRight: '10px' },
  currentAvatar: { width: '36px', height: '36px', borderRadius: '50%', backgroundColor: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px' },
  headerInfo: { display: 'flex', flexDirection: 'column' },
  headerName: { fontWeight: 'bold', fontSize: '16px' },
  headerStatus: { fontSize: '12px', opacity: 0.8 },

  // --- UPDATED MESSAGES AREA (WITH WALLPAPER) ---
  messagesArea: { 
    flex: 1, 
    // backgroundImage property applies the smoky wallaper
    backgroundImage: `url(${chatBg})`, 
    backgroundSize: 'cover', 
    backgroundPosition: 'center',
    padding: '15px', 
    overflowY: 'auto' 
  },
  
  msgRow: { display: 'flex', marginBottom: '8px' },
  bubble: { maxWidth: '85%', padding: '6px 10px', boxShadow: '0 1px 1px rgba(0,0,0,0.1)', display: 'flex', flexDirection: 'column' },
  senderLabel: { color: '#0066cc', fontSize: '11px', fontWeight: 'bold', marginBottom: '2px' },
  timestamp: { alignSelf: 'flex-end', fontSize: '10px', color: '#888', marginTop: '3px' },

  inputBar: { backgroundColor: '#f0f2f5', padding: '8px 12px', display: 'flex', alignItems: 'center', gap: '10px' },
  inputContainer: { flex: 1, backgroundColor: 'white', borderRadius: '20px', padding: '8px 12px', display: 'flex', alignItems: 'center' },
  inputField: { width: '100%', border: 'none', outline: 'none', fontSize: '14px' },
};